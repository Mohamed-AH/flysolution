<div class="flex h-screen bg-gray-800 text-white font-['Whitney','Helvetica','Arial',sans-serif]">

  <!-- Server (apps) Sidebar -->
  <div class="w-16 bg-gray-900 flex flex-col items-center py-3 space-y-2">
    <!-- Main Activity Icon -->
    <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center cursor-pointer hover:rounded-xl transition-all duration-200">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
    </div>
    
    <!-- Separator -->
    <div class="w-8 h-0.5 bg-gray-700 rounded"></div>
    
    <!-- App Icons -->
    <%= for app <- @apps do %>
      <div 
        class={"w-12 h-12 rounded-2xl flex items-center justify-center cursor-pointer transition-all duration-200 relative " <>
        if(@selected_app == app.id, do: "bg-indigo-500 rounded-xl", else: "bg-gray-700 hover:bg-indigo-500 hover:rounded-xl")}
        phx-click="select_app"
        phx-value-app={app.id}
      >
        <span class="text-lg"><%= app_icon(app.type) %></span>
        <div class={"absolute -right-1 -bottom-1 w-4 h-4 rounded-full border-2 border-gray-900 " <>
        case app.status do
          "deployed" -> "bg-green-500"
          "pending" -> "bg-yellow-500"
          "suspended" -> "bg-red-500"
          _ -> "bg-gray-400"
        end
        }></div>
      </div>
    <% end %>
  </div>

  <!-- Channels Sidebar -->
  <div class="w-60 bg-gray-700 flex flex-col">
    <!-- Header -->
    <div class="h-12 px-4 flex items-center border-b border-gray-600 shadow-md">
      <h1 class="text-white font-semibold">Fly.io Production</h1>
    </div>
    
    <div class="flex-1 pt-4">
      <!-- Launch App Button -->
      <div class="px-2 mb-4">
        <button
          phx-click="show_launch_modal"
          class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-md transition-colors duration-200 shadow-sm"
        >
          + Launch New App
        </button>
      </div>

      <!-- Applications Section -->
      <div class="px-2 mb-2">
        <div class="flex items-center px-2 text-gray-300 text-xs font-bold uppercase tracking-wider">
          <svg class="w-4 h-4 mr-2 text-indigo-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h2.94l.56-2.243a1 1 0 111.94.486L14.53 6H17a1 1 0 110 2h-2.97l-1 4H15a1 1 0 110 2h-2.47l-.56 2.242a1 1 0 11-1.94-.485L10.47 14H7.53l-.56 2.242a1 1 0 11-1.94-.485L5.47 14H3a1 1 0 110-2h2.97l1-4H5a1 1 0 110-2h2.47l.56-2.243a1 1 0 011.213-.727zM9.03 8l-1 4h2.94l1-4H9.03z" clip-rule="evenodd"/>
          </svg>
          Applications
          <div class="ml-auto bg-gray-600 text-gray-200 px-2 py-0.5 rounded-full text-xs font-medium">
            <%= length(@apps) %>
          </div>
        </div>
      </div>
      
      <!-- App List -->
      <div class="space-y-0.5 px-2">
        <%= for app <- @apps do %>
          <div
            class={"flex items-center px-2 py-1.5 rounded cursor-pointer group transition-colors duration-150 " <>
              if(@selected_app == app.id, do: "bg-gray-600 text-white", else: "text-gray-300 hover:bg-gray-600 hover:text-white")}
            phx-click="select_app"
            phx-value-app={app.id}
          >
            <svg class="w-5 h-5 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h2.94l.56-2.243a1 1 0 111.94.486L14.53 6H17a1 1 0 110 2h-2.97l-1 4H15a1 1 0 110 2h-2.47l-.56 2.242a1 1 0 11-1.94-.485L10.47 14H7.53l-.56 2.242a1 1 0 11-1.94-.485L5.47 14H3a1 1 0 110-2h2.97l1-4H5a1 1 0 110-2h2.47l.56-2.243a1 1 0 011.213-.727zM9.03 8l-1 4h2.94l1-4H9.03z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm font-medium flex-1 text-white"><%= app.name %></span>
            <div class="ml-auto flex items-center space-x-1">
              <span class="text-xs text-gray-300"><%= app_status_icon(app.status) %></span>
            </div>
            <!-- Destroy button -->
            <button
              phx-click="show_destroy_modal"
              phx-value-app={app.id}
              phx-stop-propagation
              class="ml-2 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 text-xs transition-opacity duration-200"
              title="Destroy App"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
            </button>
          </div>
        <% end %>
      </div>
      
      <!-- Live Metrics Panel -->
      <%= if @selected_app && @app_metrics[@selected_app] do %>
        <%
          current_metrics = @app_metrics[@selected_app] || []
        %>
        <div class="mt-6 mx-2 p-3 bg-gray-800 rounded">
          <div class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wide">LIVE METRICS</div>
          <div class="space-y-1 text-xs">
            <%= for {label, result} <- current_metrics do %>
              <div>
                <%= case result do %>
                  <% {:ok, []} -> %>
                    <div class="flex justify-between text-gray-300">
                      <span><%= label %>:</span>
                      <span class="text-gray-500 italic">No data</span>
                    </div>
                  <% {:ok, data} -> %>
                    <%= for metric <- data do %>
                      <%= if label == "Memory Usage (%)" and metric["value"] do %>
                        <div class="flex justify-between text-gray-300">
                          <span>Memory:</span>
                          <%
                            memory_val = Float.round(String.to_float(Enum.at(metric["value"], 1)), 1)
                          %>
                          <span class={if memory_val > 80, do: "text-red-400", else: "text-green-400"}>
                            <%= memory_val %>%
                          </span>
                        </div>
                      <% end %>
                      <%= if label == "CPU Usage" and metric["value"] do %>
                        <div class="flex justify-between text-gray-300">
                          <span>CPU:</span>
                          <%
                            cpu_val = Float.round(String.to_float(Enum.at(metric["value"], 1)), 2)
                          %>
                          <span class={if cpu_val > 70, do: "text-red-400", else: "text-green-400"}>
                            <%= cpu_val %>%
                          </span>
                        </div>
                      <% end %>
                      <%= if label == "HTTP Responses (by status)" and metric["metric"]["status"] do %>
                        <div class="flex justify-between text-gray-300">
                          <span>Status <%= metric["metric"]["status"] %>:</span>
                          <span class={case metric["metric"]["status"] do
                            "200" -> "text-green-400"
                            "404" -> "text-yellow-400"
                            "502" -> "text-red-400"
                            _ -> "text-gray-400"
                          end}>
                            <%= metric["value"] |> Enum.at(1) %>
                          </span>
                        </div>
                      <% end %>
                    <% end %>
                  <% {:error, err} -> %>
                    <div class="flex justify-between text-gray-300">
                      <span><%= label %>:</span>
                      <span class="text-red-400"><%= err %></span>
                    </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="mt-6 mx-2 p-3 bg-gray-800 rounded">
          <div class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wide">LIVE METRICS</div>
          <div class="text-xs text-gray-500 italic">No metrics available yet.</div>
        </div>
      <% end %>

      <!-- Live Logs Panel -->
      <%= if @selected_app do %>
        <div class="mt-4 mx-2 flex-1 flex flex-col min-h-0 bg-gray-800 rounded">
          <!-- Logs Header -->
          <div class="p-3 border-b border-gray-700">
            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-400 font-semibold uppercase tracking-wide">LIVE LOGS</div>
              <div class="flex items-center space-x-1">
                <%= if Map.get(@log_streams, @selected_app) do %>
                  <button
                    phx-click="stop_log_stream"
                    class="px-2 py-0.5 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors"
                    title="Stop log stream"
                  >
                    ‚èπÔ∏è
                  </button>
                <% else %>
                  <button
                    phx-click="start_log_stream"
                    class="px-2 py-0.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors"
                    title="Start log stream (requires fly CLI)"
                  >
                    ‚ñ∂Ô∏è
                  </button>
                <% end %>
                <button
                  phx-click="clear_logs"
                  class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 text-white text-xs rounded transition-colors"
                  title="Clear logs"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
          
          <!-- Logs Content -->
          <div class="flex-1 overflow-y-auto p-2 font-mono text-xs min-h-0">
            <%= if @logs_loading do %>
              <div class="flex items-center justify-center h-full">
                <div class="text-gray-500 text-center">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-500 mx-auto mb-2"></div>
                  <div class="text-xs">Connecting...</div>
                </div>
              </div>
            <% else %>
              <%= if Map.get(@logs, @selected_app) && length(Map.get(@logs, @selected_app, [])) > 0 do %>
                <%= for log <- Enum.take(Map.get(@logs, @selected_app, []), -5) do %>
                  <div class="mb-1 flex text-xs">
                    <span class="text-gray-500 w-16 flex-shrink-0 mr-2"><%= log.timestamp %></span>
                    <span class={"w-8 flex-shrink-0 font-semibold mr-2 " <>
                      case log.level do
                        "error" -> "text-red-400"
                        "warn" -> "text-yellow-400"
                        "info" -> "text-blue-400"
                        "debug" -> "text-gray-400"
                        _ -> "text-gray-300"
                      end
                    }><%= String.upcase(String.slice(log.level, 0, 3)) %></span>
                    <span class="text-gray-100 flex-1 break-all leading-tight"><%= String.slice(log.message, 0, 100) %><%= if String.length(log.message) > 100, do: "..." %></span>
                  </div>
                <% end %>
                <%= if length(Map.get(@logs, @selected_app, [])) > 5 do %>
                  <div class="text-gray-500 text-center text-xs py-1">
                    ... showing last 5 entries (total: <%= length(Map.get(@logs, @selected_app, [])) %>)
                  </div>
                <% end %>
              <% else %>
                <div class="text-gray-500 text-center mt-4 text-xs">
                  <%= if Map.get(@log_streams, @selected_app) do %>
                    Waiting for logs...
                  <% else %>
                    Click ‚ñ∂Ô∏è to start streaming logs
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- User Area (bottom) -->
    <div class="h-14 bg-gray-800 px-2 flex items-center">
      <div class="flex items-center flex-1">
        <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center mr-2">
          <span class="text-sm">üë§</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium text-white truncate">Developer</div>
          <div class="text-xs text-gray-400">#1234</div>
        </div>
      </div>
      <div class="flex space-x-1">
        <!-- Mic Icon -->
        <svg class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
        </svg>
        <!-- Headphones Icon -->
        <svg class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
        </svg>
        <!-- Settings Icon -->
        <svg class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- Main Content: Chat Area -->
  <div class="flex-1 flex flex-col">
    <%
      current_app = Enum.find(@apps, &(&1.id == @selected_app))
    %>
    <!-- Chat Header -->
    <div class="h-12 px-4 flex items-center border-b border-gray-600 bg-gray-700 shadow-sm">
      <svg class="w-5 h-5 text-gray-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h2.94l.56-2.243a1 1 0 111.94.486L14.53 6H17a1 1 0 110 2h-2.97l-1 4H15a1 1 0 110 2h-2.47l-.56 2.242a1 1 0 11-1.94-.485L10.47 14H7.53l-.56 2.242a1 1 0 11-1.94-.485L5.47 14H3a1 1 0 110-2h2.97l1-4H5a1 1 0 110-2h2.47l.56-2.243a1 1 0 011.213-.727zM9.03 8l-1 4h2.94l1-4H9.03z" clip-rule="evenodd"/>
      </svg>
      <span class="font-semibold text-white">
        <%= if current_app, do: current_app.name, else: "" %>
      </span>
      <%= if current_app do %>
        <div class="ml-2 px-2 py-0.5 bg-gray-600 rounded text-xs text-gray-300">
          <%= app_status_icon(current_app.status) %> <%= current_app.status %>
        </div>
      <% end %>
      <div class="ml-auto text-sm text-gray-400">
        AI Monitoring Assistant
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4">
      <%= for msg <- @messages[@selected_app] || [] do %>
        <div class="flex space-x-3">
          <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0">
            <span class="text-lg"><%= if msg.type == :ai, do: "ü§ñ", else: "üë§" %></span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-baseline space-x-2">
              <span class="font-medium text-white">
                <%= if msg.type == :ai, do: "AI Monitor", else: "You" %>
              </span>
              <span class="text-xs text-gray-400"><%= msg.timestamp %></span>
            </div>
            <div class="mt-1 text-gray-100 whitespace-pre-wrap break-words">
              <%= raw(msg.content
                |> String.replace(~r/\*\*(.*?)\*\*/, "<strong>\\1</strong>")
                |> String.replace(~r/`(.*?)`/, "<code class=\"bg-gray-800 px-1 rounded text-sm\">\\1</code>")
                |> String.replace(~r/```([^`]*?)```/s, "<pre class=\"bg-gray-900 p-3 rounded border-l-4 border-gray-600 my-2 text-sm overflow-x-auto\"><code>\\1</code></pre>")
              ) %>
            </div>
          </div>
        </div>
      <% end %>
      
      <%= if @is_typing do %>
        <div class="flex space-x-3">
          <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
            <span class="text-lg">ü§ñ</span>
          </div>
          <div class="flex-1">
            <div class="flex items-baseline space-x-2">
              <span class="font-medium text-white">AI Monitor</span>
              <span class="text-xs text-gray-400">thinking...</span>
            </div>
            <div class="mt-1">
              <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Message Input -->
    <form phx-submit="send_message" class="p-4">
      <div class="relative">
        <input
          type="text"
          name="typing_message"
          value={@typing_message}
          phx-change="update_typing"
          placeholder={"Message #" <> (current_app && current_app.name || "")}
          class="w-full bg-gray-600 text-white px-4 py-3 pr-12 rounded-lg focus:outline-none focus:ring-0 placeholder-gray-400 transition-colors"
          autocomplete="off"
        />
        <button
          type="submit"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <!-- Launch Modal -->
  <%= if @show_launch_modal do %>
    <div class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
      <div class="relative p-6 border border-gray-600 w-96 shadow-xl rounded-lg bg-gray-800">
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-white mb-2">Launch New App</h3>
          <p class="text-sm text-gray-400">Deploy a new application to your Fly.io organization</p>
        </div>
        <.form
          for={@launch_form}
          id="launch-form"
          phx-change="validate_launch"
          phx-submit="launch_app"
        >
          <div class="mb-6">
            <label for="name" class="block text-sm font-medium text-gray-300 mb-2">
              App Name
            </label>
            <.input
              field={@launch_form[:name]}
              type="text"
              placeholder="my-awesome-app"
              class="w-full px-3 py-2.5 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 transition-colors"
              error_class="border-red-500 focus:border-red-500 focus:ring-red-400"
            />
          </div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              phx-click="hide_launch_modal"
              class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-gray-600 rounded-md hover:bg-gray-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors shadow-sm"
            >
              Launch App
            </button>
          </div>
        </.form>
      </div>
    </div>
  <% end %>

  <!-- Destroy Modal -->
  <%= if @show_destroy_modal do %>
    <div class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
      <div class="relative p-6 border border-gray-600 w-96 shadow-xl rounded-lg bg-gray-800">
        <div class="mb-6">
          <div class="flex items-center mb-3">
            <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <h3 class="text-lg font-semibold text-white">Destroy App</h3>
          </div>
          <p class="text-sm text-gray-300 leading-relaxed">
            Are you sure you want to destroy "<span class="font-semibold text-red-400"><%= @destroy_app %></span>"? 
            This action cannot be undone and will permanently delete all data.
          </p>
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            phx-click="hide_destroy_modal"
            class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-gray-600 rounded-md hover:bg-gray-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors"
          >
            Cancel
          </button>
          <button
            phx-click="destroy_app"
            class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors shadow-sm"
          >
            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Destroy App
          </button>
        </div>
      </div>
    </div>
  <% end %>
</div>